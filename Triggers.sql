CREATE TABLE PUBLIC_HOLIDAYS (
  holiday_date DATE PRIMARY KEY,
  description VARCHAR2(100)
);

--PUBLIC HOLIDAYS INSERTIONS
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-04-07', 'YYYY-MM-DD'), 'Genocide Against the Tusti Memorial Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-04-18', 'YYYY-MM-DD'), 'Good Friday');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-04-21', 'YYYY-MM-DD'), 'Easter Monday');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-05-01', 'YYYY-MM-DD'), 'Labor Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-05-30', 'YYYY-MM-DD'), 'Labor Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-06-07', 'YYYY-MM-DD'), 'Eid al-Adha');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-07-01', 'YYYY-MM-DD'), 'Independence Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-07-04', 'YYYY-MM-DD'), 'Liberation Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-08-01', 'YYYY-MM-DD'), 'Umuganura Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-08-15', 'YYYY-MM-DD'), 'Assumption of Mary');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-12-25', 'YYYY-MM-DD'), 'Christmas Day');
INSERT INTO PUBLIC_HOLIDAYS VALUES (TO_DATE('2025-12-26', 'YYYY-MM-DD'), 'Boxing Day');

--AUDIT TABLE SETUP
CREATE TABLE AUDIT_LOG (
  log_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  user_name VARCHAR2(50),
  action_type VARCHAR2(10),
  table_name VARCHAR2(50),
  action_date DATE,
  status VARCHAR2(20)
);

--RESTRICT ON WEEKDAYS AND HOLIDAYS
CREATE OR REPLACE TRIGGER trg_block_weekdays_holidays
BEFORE INSERT OR UPDATE OR DELETE ON RESERVATION
DECLARE
  v_today DATE := TRUNC(SYSDATE);
  v_day VARCHAR2(10);
  v_exists NUMBER;
BEGIN
  -- Get current day name
  SELECT TO_CHAR(SYSDATE, 'DY', 'NLS_DATE_LANGUAGE = AMERICAN') INTO v_day FROM dual;

  -- Check if it's a weekday (Mon-Fri)
  IF v_day IN ('MON','TUE','WED','THU','FRI') THEN
    RAISE_APPLICATION_ERROR(-20001, 'DML operations are blocked on weekdays!');
  END IF;

  -- Check if it's a public holiday
  SELECT COUNT(*) INTO v_exists
  FROM PUBLIC_HOLIDAYS
  WHERE holiday_date = v_today;

  IF v_exists > 0 THEN
    RAISE_APPLICATION_ERROR(-20002, 'DML operations are blocked on public holidays!');
  END IF;
END;
/

--AUDIT EVERY DML ON RESERVATION FOR TRACKING
CREATE OR REPLACE TRIGGER trg_audit_reservation
AFTER INSERT OR UPDATE OR DELETE ON RESERVATION
FOR EACH ROW
DECLARE
  v_action_type VARCHAR2(10);
BEGIN
  IF INSERTING THEN
    v_action_type := 'INSERT';
  ELSIF UPDATING THEN
    v_action_type := 'UPDATE';
  ELSIF DELETING THEN
    v_action_type := 'DELETE';
  END IF;

  INSERT INTO AUDIT_LOG (
    user_name, action_type, table_name, action_date, status
  ) VALUES (
    USER, v_action_type, 'RESERVATION', SYSDATE, 'ALLOWED'
  );
END;
/

--TESTING THE HOLIDAY RESTRICTION TRIGGERS
INSERT INTO PUBLIC_HOLIDAYS VALUES (TRUNC(SYSDATE), 'Sample Self-Made Holiday'); --Today, 20th May as a holiday
INSERT INTO RESERVATION VALUES (200, 1, 'FL001', SYSDATE, '1A');